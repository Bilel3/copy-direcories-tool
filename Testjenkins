pipeline {
    agent any

    environment {
        API_URL = 'https://oauth2.accesscontrol.cloud.socgen/v3/oauth2/access token' // Replace with your API URL
        CLIENT_ID = 'ant prd snapshot'  // Replace with your client ID
        CLIENT_SECRET = 'xxxxx'         // Replace with your client secret
        GRANT_TYPE = 'grant_type=client_credentials&2'
    }

    stages {
        stage('Authenticate with API') {
            steps {
                script {
                    // URL-encode the data to ensure it's properly formatted
                    def encodedClientId = URLEncoder.encode(CLIENT_ID, 'UTF-8')
                    def encodedClientSecret = URLEncoder.encode(CLIENT_SECRET, 'UTF-8')
                    def encodedGrantType = URLEncoder.encode(GRANT_TYPE, 'UTF-8')

                    // Prepare the request body
                    def requestBody = """client_id=${encodedClientId}&client_secret=${encodedClientSecret}&${encodedGrantType}"""

                    // Send the HTTP POST request
                    def response = httpRequest(
                        acceptType: 'APPLICATION_JSON',
                        contentType: 'APPLICATION_FORM',
                        httpMode: 'POST',
                        url: API_URL,
                        requestBody: requestBody,
                        customHeaders: [[name: 'Content-Type', value: 'application/x-www-form-urlencoded']]
                    )

                    // Log the response for debugging
                    echo "Response: ${response.content}"

                    // Check the response status
                    if (response.status != 200) {
                        error "Authentication failed with status ${response.status}"
                    }

                    // Parse the response if it's JSON
                    def jsonResponse = readJSON text: response.content
                    echo "Access Token: ${jsonResponse.access_token}" // Adjust based on actual token key
                }
            }
        }
    }

    post {
        always {
            echo "Authentication stage completed."
        }
    }
}
