pipeline {
    agent any

    environment {
        API_URL = 'https://oauth2.accesscontrol.cloud.socgen/v3/oauth2/access token' // Replace with your API URL
        CLIENT_ID = 'ant prd snapshot'  // Replace with your client ID
        CLIENT_SECRET = 'xxxxx'         // Replace with your client secret
        GRANT_TYPE = 'grant_type=client_credentials&2'
    }

    stages {
        stage('Authenticate with API') {
            steps {
                script {
                    // Prepare the request with `--data-urlencode` and `--data`
                    def requestBody = """client id=${CLIENT_ID}&client secret=${CLIENT_SECRET}&${GRANT_TYPE}"""
                    
                    // Send the HTTP POST request
                    def response = httpRequest(
                        acceptType: 'APPLICATION_JSON',
                        contentType: 'APPLICATION_FORM',
                        httpMode: 'POST',
                        url: API_URL,
                        requestBody: requestBody,
                        customHeaders: [[name: 'Content-Type', value: 'application/x-www-form-urlencoded']]
                    )

                    // Log the response
                    echo "Response: ${response.content}"

                    // Parse the response if it's JSON
                    def jsonResponse = readJSON text: response.content
                    echo "Access Token: ${jsonResponse.access_token}" // Replace with the actual key for the token
                }
            }
        }
    }

    post {
        always {
            echo "Authentication stage completed."
        }
    }
}
